# 学习笔记

#### 插入 1000000 订单数据

正常来讲，一次性插入这么多数据是不太合理的。

插入数据太多，一定要想办法减少建立 JDBC 连接的次数，因为建立连接会有额外的花销，同时过多的连接也会对数据库吞吐造成影响，这一点可以使用连接池。

同时，还需要减少 SQL 执行的次数，这就需要使用批量插入的 SQL 语句格式 `insert into table_name values (...),(....)` 
但是这样又需要考虑两点，一是构造这样的 SQL 需要很大的内存来存储集合数据，方便给 Mybatis 赋值，这就有内存溢出的风险，我测试的时候就出现了；
其二是过长的 SQL 需要设置 MySQL 数据库允许的 maxPackage size 的值，不然是可能没法执行的，真不巧这问题我又遇到了。

考虑到上面的因素之后，就可以尝试分多次执行批量插入 SQL 语句了。这样会大大减少对内存使用，相对的耗时应该会略微多一些。

但是也不能分很多次了，这样反而会占用大量的 MySQL 连接去执行 SQL。

总之，批量插入还是要根据机器的性能配置来修改对应的方案，而不是简单的使用一次性批量插入 SQL 作为第一解决方案。


#### 多数据源  读写分离
 时间来不及了，代码没完成，说下思路吧。
 
 读写分离首先得保证数据库的数据要同步，拿最简单的来说就是要做主从同步。
 
 MySQL 的主从同步需要设置 server_id, 主库需要开启 bin log，同时给从库建一个用户并且分配权限，最后记录下主库的 bin log 名称和偏移量。
 
 从库同样需要设置 server_id，至于 bin log 不是必须的，除非这个从库可能会变成主库。
 然后配置主库的地址、端口、用户名、密码以及上面的 bin log 名称和偏移量。
 最后开启主从同步进程，检查同步状态。
 
 到了这里就可以用代码实现读写分离了，本质上就是配置多个数据源，根据查询和修改的 SQL 去使用不同的数据源，这样 SQL 的执行就会在不同的数据库里去执行。